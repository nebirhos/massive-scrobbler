#!/usr/bin/env ruby

require 'rubygems' if RUBY_VERSION < '1.9'
require 'activesupport' # activesupport WTF?
require 'scrobbler'
require 'mp3info'
require 'choice'


ROOT_PATH = File.dirname( File.expand_path( File.dirname( __FILE__ ) ) )
LIB_PATH  = File.join( ROOT_PATH, 'lib' )
$:.unshift( ROOT_PATH )

require 'lib/massive_scrobbler'


Choice.options do
  header 'MassiveScrobbler options:'

  option :path do
    short '-p'
    long '--path'
    desc 'Path where to search the audio files [default: current directory].'
    default './'
  end

  option :help do
    short '-h'
    long '--help'
    desc 'Show this message.'
  end

  option :version do
    short '-v'
    long '--version'
    desc 'Show version.'
    action do
      puts "MassiveScrobbler #{MassiveScrobbler::VERSION}"
      exit
    end
  end
end

puts Choice.choices.path

s = MassiveScrobbler::Songs.new(Choice.choices.path)
u = MassiveScrobbler::User.new

aMp3Info = s.songs.collect do |mp3|
  Mp3Info.open(mp3) do |mp3info|
    { :length => mp3info.length.to_i,
      :artist => mp3info.tag.artist,
      :title  => mp3info.tag.title,
      :album  => mp3info.tag.album,
      :trackn => mp3info.tag.tracknum }
  end
end

auth = Scrobbler::SimpleAuth.new(:user => u.user, :password => u.password)
auth.handshake!

puts "Auth Status: #{auth.status}"
puts "Session ID: #{auth.session_id}"
puts "Now Playing URL: #{auth.now_playing_url}"
puts "Submission URL: #{auth.submission_url}"

aMp3Info.each do |mp3|
  scrobble = Scrobbler::Scrobble.new(:session_id => auth.session_id,
                                     :submission_url => auth.submission_url,
                                     :artist => mp3[:artist],
                                     :track => mp3[:title],
                                     :album => mp3[:album],
                                     :time => Time.new,
                                     :length => mp3[:length],
                                     :track_number => mp3[:trackn])
  scrobble.submit!
  puts "#{mp3[:title]}: #{scrobble.status}"
end
